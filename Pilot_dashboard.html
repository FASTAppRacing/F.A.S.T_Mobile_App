<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>FAST Dashboard</title>

<script src="https://cdn.tailwindcss.com"></script>

<style>
html, body {
    height: 100%;
    margin: 0;
    background-color: #111827;
    font-family: Inter, system-ui, sans-serif;
}

.card {
    background-color: #1f2933;
    border-radius: 1rem;
    padding: 1rem;
    box-shadow: 0 8px 24px rgba(0,0,0,0.35);
}

.dot {
    width: 14px;
    height: 14px;
    border-radius: 9999px;
}

.flash-green { animation: flashGreen 0.6s ease-out; }
.flash-red   { animation: flashRed 0.6s ease-out; }
.flash-yellow{ animation: flashYellow 0.6s ease-out; }

@keyframes flashGreen {
    0% { background-color: #064e3b; }
    100% { background-color: #1f2933; }
}
@keyframes flashRed {
    0% { background-color: #7f1d1d; }
    100% { background-color: #1f2933; }
}
@keyframes flashYellow {
    0% { background-color: #78350f; }
    100% { background-color: #1f2933; }
}
</style>
</head>

<body class="flex flex-col items-center p-4 text-white overscroll-none">

<!-- LOGIN -->
<div id="login" class="w-full max-w-sm mt-24">
    <h1 class="text-3xl font-bold text-center text-yellow-400 mb-6">
        FAST Dashboard
    </h1>

    <div class="card">
        <input id="sessionInput" maxlength="4"
            class="w-full p-3 mb-4 text-center text-2xl uppercase font-mono bg-gray-700 rounded-lg"
            placeholder="A7B2">

        <button id="connectBtn"
            class="w-full bg-green-600 hover:bg-green-700 py-3 rounded-lg font-bold">
            Connect
        </button>
    </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden w-full max-w-xl space-y-4">

    <div class="text-center text-gray-400">
        Session <span id="sessionLabel" class="text-yellow-400 font-mono"></span>
    </div>

    <!-- TRACK STATUS -->
    <div class="card flex items-center justify-between">
        <div class="text-sm uppercase text-gray-400">Track status</div>
        <div class="flex items-center gap-2">
            <div id="trackDot" class="dot bg-gray-500"></div>
            <div id="trackLabel" class="font-bold">UNKNOWN</div>
        </div>
    </div>

    <!-- PIT -->
    <div id="pitCard" class="card text-center">
        <div class="text-sm uppercase text-gray-400">Pit Window</div>
        <div id="pitStatus" class="text-3xl font-extrabold mt-1">UNKNOWN</div>
        <div id="pitTime" class="text-sm text-gray-400 mt-1"></div>
    </div>

    <!-- MESSAGE TO PILOT -->
    <div id="messageCard" class="card">
        <div class="text-sm uppercase text-gray-400 mb-1">
            Message to pilot
        </div>
        <div id="pilotMessage" class="text-lg font-mono text-gray-300">
            No message
        </div>
    </div>

    <!-- DRIVERS -->
    <div id="drivers" class="space-y-3"></div>

    <button id="disconnectBtn"
        class="mt-4 bg-gray-600 hover:bg-gray-700 py-2 rounded-lg text-sm">
        Disconnect
    </button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
/* ---------------------------------------------------- */
/* FIREBASE CONFIG                                      */
/* ---------------------------------------------------- */
firebase.initializeApp({
    apiKey: "AIzaSyDY9ceRQr2KYQvEdzmUMypo5fcpAeivzAY",
    authDomain: "fast-mobile-app-001.firebaseapp.com",
    databaseURL: "https://fast-mobile-app-001-default-rtdb.europe-west1.firebasedatabase.app"
});
const db = firebase.database();

/* ---------------------------------------------------- */
/* STATE                                                */
/* ---------------------------------------------------- */
let sessionId = null;
let lastData = null;
let listener = null;

/* ---------------------------------------------------- */
/* DOM                                                  */
/* ---------------------------------------------------- */
const login = document.getElementById("login");
const dashboard = document.getElementById("dashboard");
const driversDiv = document.getElementById("drivers");

const pitCard   = document.getElementById("pitCard");
const pitStatus = document.getElementById("pitStatus");
const pitTime   = document.getElementById("pitTime");

const trackDot   = document.getElementById("trackDot");
const trackLabel = document.getElementById("trackLabel");

const pilotMessage = document.getElementById("pilotMessage");

/* ---------------------------------------------------- */
/* HELPERS                                              */
/* ---------------------------------------------------- */
function flash(el, cls) {
    el.classList.remove(cls);
    void el.offsetWidth;
    el.classList.add(cls);
}

function fmtTime(iso) {
    if (!iso) return "";
    return new Date(iso).toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit"
    });
}

/* ---------------------------------------------------- */
/* CONNECT                                              */
/* ---------------------------------------------------- */
document.getElementById("connectBtn").onclick = () => {
    const id = document.getElementById("sessionInput")
        .value.trim().toUpperCase();

    if (id.length !== 4) return;

    sessionId = id;
    localStorage.setItem("FAST_SESSION", id);

    document.getElementById("sessionLabel").textContent = id;
    login.classList.add("hidden");
    dashboard.classList.remove("hidden");

    startListener();
};

/* ---------------------------------------------------- */
/* AUTO RECONNECT                                       */
/* ---------------------------------------------------- */
window.addEventListener("load", () => {
    const saved = localStorage.getItem("FAST_SESSION");
    if (!saved) return;

    sessionId = saved;
    document.getElementById("sessionLabel").textContent = saved;

    login.classList.add("hidden");
    dashboard.classList.remove("hidden");

    startListener();
});

/* ---------------------------------------------------- */
/* LISTENER                                             */
/* ---------------------------------------------------- */
function startListener() {
    const ref = db.ref(`Users/${sessionId}/data`);

    listener = ref.on("value", snap => {
        const data = snap.val();
        if (!data) return;

        updateTrack(data.track_status);
        updatePit(data.pit);
        updateMessage(data.message);
        updateDrivers(data.drivers);

        lastData = data;
    });
}

/* ---------------------------------------------------- */
/* TRACK STATUS                                         */
/* ---------------------------------------------------- */
function updateTrack(track) {
    if (!track) return;

    const status = track.track_status ?? "UNKNOWN";
    trackLabel.textContent = status;

    trackDot.className = "dot";

    if (status === "GREEN") {
        trackDot.classList.add("bg-green-500");
    } else if (status === "FCY") {
        trackDot.classList.add("bg-yellow-400");
    } else if (status === "RED FLAG") {
        trackDot.classList.add("bg-red-500");
    } else {
        trackDot.classList.add("bg-gray-500");
    }
}

/* ---------------------------------------------------- */
/* PIT                                                  */
/* ---------------------------------------------------- */
function updatePit(pit) {
    if (!pit) return;

    const open = pit.status === true;

    pitStatus.textContent = open ? "OPEN" : "CLOSED";
    pitStatus.className =
        "text-3xl font-extrabold " +
        (open ? "text-green-400" : "text-red-400");

    pitTime.textContent = open && pit.close_at
        ? "Closes at " + fmtTime(pit.close_at)
        : !open && pit.open_at
        ? "Opens at " + fmtTime(pit.open_at)
        : "";

    if (!lastData || pit.status !== lastData.pit?.status) {
        flash(pitCard, open ? "flash-green" : "flash-red");
    }
}

/* ---------------------------------------------------- */
/* MESSAGE TO PILOT                                     */
/* ---------------------------------------------------- */
function updateMessage(msg) {
    const text = msg?.message;

    pilotMessage.textContent = text && text.trim()
        ? text
        : "No message";
}

/* ---------------------------------------------------- */
/* DRIVERS                                              */
/* ---------------------------------------------------- */
function updateDrivers(drivers) {
    if (!drivers) return;

    driversDiv.innerHTML = "";

    Object.entries(drivers).forEach(([id, d]) => {
        const prev = lastData?.drivers?.[id];

        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
            <div class="flex justify-between items-center">
                <span class="font-bold text-yellow-400">
                    ${d.name ?? id}
                </span>
                <span class="text-sm text-gray-400">
                    Stints ${d.stints_done ?? 0}
                </span>
            </div>

            <div class="flex justify-between mt-2 text-sm">
                <span>Best lap</span>
                <span class="font-mono text-green-400">
                    ${d.best_lap ?? "--"}
                </span>
            </div>
        `;

        if (!prev || d.best_lap !== prev.best_lap) {
            flash(card, "flash-green");
        }
        if (prev && d.stints_done !== prev.stints_done) {
            flash(card, "flash-yellow");
        }

        driversDiv.appendChild(card);
    });
}

/* ---------------------------------------------------- */
/* DISCONNECT                                           */
/* ---------------------------------------------------- */
document.getElementById("disconnectBtn").onclick = () => {
    if (listener) {
        db.ref(`Users/${sessionId}/data`).off("value", listener);
    }

    localStorage.removeItem("FAST_SESSION");

    sessionId = null;
    lastData = null;
    driversDiv.innerHTML = "";

    dashboard.classList.add("hidden");
    login.classList.remove("hidden");
};
</script>
</body>
</html>
