<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Dashboard - FAST Mobile App</title>
    <!-- Using Tailwind CSS for a responsive and modern design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ensure content uses full screen height on mobile */
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden; 
            font-family: 'Inter', sans-serif;
        }
        .data-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .data-value {
            line-height: 1; /* Optimizing line height for the large number */
            font-weight: 800;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-start min-h-screen p-4">

    <!-- Login Screen (displayed by default) -->
    <div id="loginScreen" class="w-full max-w-md mt-16">
        <h1 class="text-3xl font-bold text-center text-yellow-400 mb-6">FAST Driver Dashboard</h1>
        <div class="bg-gray-800 p-6 rounded-xl data-card">
            <label for="sessionId" class="block text-sm font-medium text-gray-300 mb-2">Enter Session Code (4 characters):</label>
            <input type="text" id="sessionId" maxlength="4" placeholder="Ex: A7B2" class="w-full p-3 mb-4 text-center text-2xl font-mono uppercase tracking-widest bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 text-yellow-400">
            <button id="connectButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-150">
                Connect and Start
            </button>
            <p id="errorMsg" class="text-red-400 text-center mt-4 hidden">Invalid Code. Please try again.</p>
        </div>
    </div>

    <!-- Dashboard Screen (displayed after connection) -->
    <div id="dashboard" class="w-full max-w-3xl hidden flex flex-col items-center justify-center p-4">
        
        <div class="mb-6 text-center">
            <h2 class="text-xl font-semibold text-gray-300">Session ID: <span id="displaySessionId" class="text-yellow-400 font-mono text-2xl"></span></h2>
        </div>

        <!-- Indicators Grid -->
        <div class="grid grid-cols-2 gap-4 w-full">
            
            <!-- Speed -->
            <div class="data-card bg-gray-800 p-5 rounded-xl text-center">
                <p class="text-sm uppercase text-gray-400 mb-1">Current Speed (KM/H)</p>
                <div id="speedValue" class="data-value text-7xl md:text-8xl text-red-500 animate-pulse">0</div>
            </div>

            <!-- RPM -->
            <div class="data-card bg-gray-800 p-5 rounded-xl text-center">
                <p class="text-sm uppercase text-gray-400 mb-1">Engine RPM</p>
                <div id="rpmValue" class="data-value text-7xl md:text-8xl text-blue-500">0</div>
            </div>

            <!-- Lap -->
            <div class="data-card bg-gray-800 p-5 rounded-xl text-center col-span-2">
                <p class="text-sm uppercase text-gray-400 mb-1">Current Lap</p>
                <div id="lapValue" class="data-value text-8xl md:text-9xl text-green-500">0</div>
            </div>
            
        </div>

        <!-- Disconnect Button -->
        <button id="disconnectButton" class="mt-8 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 text-sm">
            Disconnect
        </button>
    </div>

    <!-- Firebase Scripts -->
    <!-- We use the compatibility version for simplicity -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <script>
        // ---------------------------------------------------------
        // 1. FIREBASE CONFIGURATION (Must match your Python .exe config)
        // ---------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyDY9ceRQr2KYQvEdzmUMypo5fcpAeivzAY",
            authDomain: "fast-mobile-app-001.firebaseapp.com",
            databaseURL: "https://fast-mobile-app-001-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "fast-mobile-app-001",
            storageBucket: "fast-mobile-app-001.firebasestorage.app",
            messagingSenderId: "503921954998",
            appId: "1:503921954998:web:afced2b8ef8a3c789a1617"
        };

        // ---------------------------------------------------------
        // 2. GLOBAL VARIABLES AND INITIALIZATION
        // ---------------------------------------------------------
        let app;
        let db;
        let currentSessionId = null;
        let dataListener = null; // Stores the reference to the Firebase real-time listener

        // DOM References
        const loginScreen = document.getElementById('loginScreen');
        const dashboard = document.getElementById('dashboard');
        const connectButton = document.getElementById('connectButton');
        const disconnectButton = document.getElementById('disconnectButton');
        const sessionIdInput = document.getElementById('sessionId');
        const errorMsg = document.getElementById('errorMsg');
        const speedValue = document.getElementById('speedValue');
        const rpmValue = document.getElementById('rpmValue');
        const lapValue = document.getElementById('lapValue');
        const displaySessionId = document.getElementById('displaySessionId');


        // Initialize Firebase once the DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            try {
                app = firebase.initializeApp(firebaseConfig);
                db = app.database();
                console.log("Firebase initialized.");
            } catch (e) {
                console.error("Firebase initialization error:", e);
                errorMsg.textContent = "Could not connect to the service. Check your connection.";
                errorMsg.classList.remove('hidden');
                connectButton.disabled = true;
            }
        });

        // ---------------------------------------------------------
        // 3. CONNECTION LOGIC
        // ---------------------------------------------------------
        connectButton.addEventListener('click', () => {
            // Get input, trim spaces, convert to uppercase
            const inputId = sessionIdInput.value.trim().toUpperCase();
            
            if (inputId.length !== 4) {
                errorMsg.textContent = "Code must be 4 characters long.";
                errorMsg.classList.remove('hidden');
                return;
            }
            
            // 1. Check if the session exists before connecting
            const sessionRef = db.ref('courses/' + inputId);
            sessionRef.once('value', (snapshot) => {
                if (snapshot.exists()) {
                    // Session exists, start listening for data
                    currentSessionId = inputId;
                    startDataListener(inputId);
                    
                    // Switch UI
                    loginScreen.classList.add('hidden');
                    dashboard.classList.remove('hidden');
                    displaySessionId.textContent = inputId;
                    errorMsg.classList.add('hidden');

                } else {
                    // Session not found (wrong code or PC is offline)
                    errorMsg.textContent = "Session not found. PC must be actively sending data.";
                    errorMsg.classList.remove('hidden');
                }
            });
        });

        // ---------------------------------------------------------
        // 4. REAL-TIME LISTENER (onSnapshot) - FIXED KEYS
        // ---------------------------------------------------------
        function startDataListener(sessionId) {
            // Target the exact path where the PC sends data: /courses/[ID]/telemetry
            const telemetryRef = db.ref('courses/' + sessionId + '/telemetry'); 

            // 'on' sets up the real-time listener. This function runs every time the data changes.
            dataListener = telemetryRef.on('value', (snapshot) => {
                const data = snapshot.val();

                if (data) {
                    // Update the UI using the correct keys: 'speed', 'lap', 'rpm'
                    speedValue.textContent = data.speed !== undefined ? Math.round(data.speed) : 0;
                    rpmValue.textContent = data.rpm !== undefined ? Math.round(data.rpm) : 0;
                    lapValue.textContent = data.lap !== undefined ? Math.round(data.lap) : 0;
                    
                    // Remove the pulse effect when data is received
                    speedValue.classList.remove('animate-pulse');

                } else {
                    console.warn("Telemetry data is empty or corrupted.");
                    // Display zeros if data is suddenly empty
                    speedValue.textContent = 0;
                    rpmValue.textContent = 0;
                    lapValue.textContent = 0;
                    speedValue.classList.add('animate-pulse'); // Start pulsing again to indicate waiting
                }
            }, (error) => {
                // Handle listener errors (e.g., security issues)
                console.error("Firebase Listener Error:", error);
                // We use custom UI/console log instead of alert()
                console.log("Real-time connection error. Please reconnect.");
                handleDisconnect();
            });
        }

        // ---------------------------------------------------------
        // 5. DISCONNECTION LOGIC
        // ---------------------------------------------------------
        disconnectButton.addEventListener('click', handleDisconnect);

        function handleDisconnect() {
            if (dataListener) {
                // Remove the listener to save battery and bandwidth
                db.ref('courses/' + currentSessionId + '/telemetry').off('value', dataListener);
                dataListener = null;
            }

            // Reset the interface
            dashboard.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            sessionIdInput.value = '';
            currentSessionId = null;
            
            // Reset displays to zero
            speedValue.textContent = 0;
            rpmValue.textContent = 0;
            lapValue.textContent = 0;
        }

    </script>
</body>
</html>